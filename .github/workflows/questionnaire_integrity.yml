name: Questionnaire Integrity Check

on:
  push:
    branches: ['**']
    paths:
      - 'data/questionnaire_monolith.json'
      - 'src/**/*.py'
      - 'tests/**/*.py'
      - '.github/workflows/questionnaire_integrity.yml'
  pull_request:
    branches: ['**']
    paths:
      - 'data/questionnaire_monolith.json'
      - 'src/**/*.py'
      - 'tests/**/*.py'
      - '.github/workflows/questionnaire_integrity.yml'

jobs:
  verify-questionnaire-integrity:
    name: Verify Questionnaire Integrity
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Verify Questionnaire Hash
        run: |
          echo "════════════════════════════════════════════════════════════════"
          echo "Verifying questionnaire SHA-256 hash..."
          echo "════════════════════════════════════════════════════════════════"

          # Compute actual hash of questionnaire file
          ACTUAL=$(python -c "
          import json
          import hashlib

          with open('data/questionnaire_monolith.json', 'r', encoding='utf-8') as f:
              data = json.load(f)

          canonical_json = json.dumps(data, sort_keys=True, ensure_ascii=True, separators=(',', ':'))
          sha256 = hashlib.sha256(canonical_json.encode('utf-8')).hexdigest()
          print(sha256)
          ")

          # Extract expected hash from questionnaire.py
          EXPECTED=$(python -c "
          from saaaaaa.core.orchestrator.questionnaire import EXPECTED_HASH
          print(EXPECTED_HASH)
          ")

          echo "Expected hash: $EXPECTED"
          echo "Actual hash:   $ACTUAL"

          if [ "$ACTUAL" != "$EXPECTED" ]; then
            echo ""
            echo "❌ QUESTIONNAIRE INTEGRITY VIOLATION!"
            echo "════════════════════════════════════════════════════════════════"
            echo "The questionnaire file has been modified but EXPECTED_HASH"
            echo "in src/saaaaaa/core/orchestrator/questionnaire.py was not updated."
            echo ""
            echo "If this change was intentional, update EXPECTED_HASH to:"
            echo "  $ACTUAL"
            echo ""
            echo "Location: src/saaaaaa/core/orchestrator/questionnaire.py line 45"
            echo "════════════════════════════════════════════════════════════════"
            exit 1
          fi

          echo "✅ Questionnaire hash verified: $ACTUAL"

      - name: Verify Import Discipline
        run: |
          echo ""
          echo "════════════════════════════════════════════════════════════════"
          echo "Verifying import discipline (no direct file access)..."
          echo "════════════════════════════════════════════════════════════════"

          # Find all Python files that directly access questionnaire_monolith.json
          # EXCEPT questionnaire.py (the only authorized loader)
          VIOLATIONS=$(grep -r "questionnaire_monolith\.json" \
            --include="*.py" \
            --exclude="questionnaire.py" \
            --exclude="*test*.py" \
            src/ || true)

          if [ ! -z "$VIOLATIONS" ]; then
            echo "❌ DIRECT QUESTIONNAIRE ACCESS DETECTED!"
            echo "════════════════════════════════════════════════════════════════"
            echo "The following files directly access questionnaire_monolith.json:"
            echo ""
            echo "$VIOLATIONS"
            echo ""
            echo "ONLY src/saaaaaa/core/orchestrator/questionnaire.py may load"
            echo "questionnaire_monolith.json. All other modules must use:"
            echo ""
            echo "  from saaaaaa.core.orchestrator.questionnaire import load_questionnaire"
            echo "  questionnaire = load_questionnaire()"
            echo "════════════════════════════════════════════════════════════════"
            exit 1
          fi

          echo "✅ Import discipline verified (no violations)"

      - name: Verify Canonical Loader Works
        run: |
          echo ""
          echo "════════════════════════════════════════════════════════════════"
          echo "Testing canonical questionnaire loader..."
          echo "════════════════════════════════════════════════════════════════"

          python -c "
          from saaaaaa.core.orchestrator.questionnaire import (
              load_questionnaire,
              EXPECTED_HASH,
              EXPECTED_MICRO_QUESTION_COUNT,
              EXPECTED_TOTAL_QUESTION_COUNT
          )

          # Load questionnaire
          q = load_questionnaire()

          # Verify type
          assert hasattr(q, 'data'), 'CanonicalQuestionnaire missing data attribute'
          assert hasattr(q, 'sha256'), 'CanonicalQuestionnaire missing sha256 attribute'
          assert hasattr(q, 'micro_questions'), 'CanonicalQuestionnaire missing micro_questions attribute'

          # Verify hash
          assert q.sha256 == EXPECTED_HASH, f'Hash mismatch: {q.sha256[:16]}... != {EXPECTED_HASH[:16]}...'

          # Verify question count
          assert q.micro_question_count == EXPECTED_MICRO_QUESTION_COUNT, f'Expected {EXPECTED_MICRO_QUESTION_COUNT} micro questions, got {q.micro_question_count}'
          assert q.total_question_count == EXPECTED_TOTAL_QUESTION_COUNT, f'Expected {EXPECTED_TOTAL_QUESTION_COUNT} total questions, got {q.total_question_count}'

          # Verify immutability
          from types import MappingProxyType
          assert isinstance(q.data, MappingProxyType), 'data must be MappingProxyType'
          assert isinstance(q.micro_questions, tuple), 'micro_questions must be tuple'

          print('✅ CANONICAL LOADER VALIDATED')
          print(f'   SHA-256: {q.sha256[:16]}...')
          print(f'   Questions: {q.micro_question_count} micro + {len(q.meso_questions)} meso + {1 if q.macro_question else 0} macro = {q.total_question_count} total')
          print(f'   Version: {q.version}')
          print(f'   Schema: {q.schema_version}')
          "

      - name: Verify No Mutable Questionnaire Usage
        run: |
          echo ""
          echo "════════════════════════════════════════════════════════════════"
          echo "Checking for unsafe mutable questionnaire patterns..."
          echo "════════════════════════════════════════════════════════════════"

          # Look for patterns that modify questionnaire in-place
          MUTABLE_PATTERNS=$(grep -r "questionnaire\[" \
            --include="*.py" \
            --exclude="*test*.py" \
            --exclude="questionnaire.py" \
            --exclude="factory.py" \
            --exclude="signal_loader.py" \
            src/ || true)

          if [ ! -z "$MUTABLE_PATTERNS" ]; then
            echo "⚠️  WARNING: Potential mutable questionnaire access detected"
            echo ""
            echo "$MUTABLE_PATTERNS"
            echo ""
            echo "Review these patterns to ensure they use MappingProxyType or tuple access"
            # Don't fail - this is just a warning
          else
            echo "✅ No obvious mutable questionnaire patterns detected"
          fi

      - name: Summary
        if: success()
        run: |
          echo ""
          echo "════════════════════════════════════════════════════════════════"
          echo "✅ QUESTIONNAIRE INTEGRITY CHECK PASSED"
          echo "════════════════════════════════════════════════════════════════"
          echo "All checks passed:"
          echo "  ✅ Hash verification"
          echo "  ✅ Import discipline"
          echo "  ✅ Canonical loader validation"
          echo "  ✅ Immutability enforcement"
          echo ""
          echo "Questionnaire integrity is maintained!"
          echo "════════════════════════════════════════════════════════════════"
